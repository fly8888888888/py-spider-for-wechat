# 智能查询功能优化说明

## 优化概述

基于WeChat.py的自然语言SQL查询设计理念，我们为main.py实现了一个本地化的智能查询功能，无需依赖外部AI API，即可实现基本的自然语言到SQL的转换。

## 优化内容

### 1. 本地自然语言解析引擎

创建了`SimpleEnhancedDBManager`类，内置智能解析功能：

```python
def parse_natural_language_to_sql(self, query_text):
    """简化的自然语言解析，生成基本SQL查询"""
```

### 2. 支持的查询类型

#### 🏢 公众号名称识别
```
用户输入：查找量子位发布的文章
SQL输出：WHERE account_name LIKE '%量子位%'

支持模式：
- "查找/搜索 [公众号名] 发布的文章"
- "[公众号名] 发布的内容"
- "公众号 [公众号名]"
```

#### 🔍 关键词搜索
```
用户输入：包含AI的文章
SQL输出：WHERE (title LIKE '%AI%' OR digest LIKE '%AI%' OR content LIKE '%AI%')

支持模式：
- "关于 [关键词] 的文章"
- "包含 [关键词] 的文章"
- "标题包含 [关键词]"
- "[关键词] 相关文章"
```

#### ⏰ 时间范围查询
```
用户输入：最近3天的文章
SQL输出：WHERE publish_timestamp >= [3天前的时间戳]

支持模式：
- "最近 N 天/周/月"
- "今天/昨天"
- "本周/本月"
```

#### 📊 数量限制
```
用户输入：只要前10篇文章
SQL输出：LIMIT 10

支持模式：
- "前/最新/最近 N 篇"
- "N 篇文章"
- "限制 N 条"
```

#### 🔄 排序方式
```
用户输入：按时间升序排列
SQL输出：ORDER BY publish_timestamp ASC

支持模式：
- "时间升序/正序"
- "标题排序"
- 默认：时间倒序
```

### 3. 复合查询示例

| 自然语言查询 | 生成的SQL |
|-------------|----------|
| `查找量子位发布的关于AI的文章，只要前5篇` | `SELECT ... WHERE account_name LIKE '%量子位%' AND (title LIKE '%AI%' OR ...) ORDER BY publish_timestamp DESC LIMIT 5` |
| `最近一周包含"人工智能"的文章` | `SELECT ... WHERE publish_timestamp >= [一周前] AND (title LIKE '%人工智能%' OR ...) ORDER BY publish_timestamp DESC LIMIT 20` |
| `今天的文章按时间升序` | `SELECT ... WHERE publish_timestamp >= [今天0点] ORDER BY publish_timestamp ASC LIMIT 20` |

## 技术实现特点

### 1. 正则表达式匹配
使用多组正则表达式模式匹配不同的查询意图：
```python
account_patterns = [
    r'(?:查找|搜索|找).*?([^，。！？\s]{2,10}?)(?:发布|公众号|的)',
    r'([^，。！？\s]{2,10}?)(?:发布|公众号).*?(?:文章|内容)',
    r'公众号[\s]*([^，。！？\s]{2,10})',
]
```

### 2. 时间戳计算
智能计算相对时间：
```python
if unit == 'days':
    start_timestamp = current_timestamp - num * 24 * 3600
elif unit == 'weeks':
    start_timestamp = current_timestamp - num * 7 * 24 * 3600
```

### 3. 安全限制
- 限制查询结果数量（最多100篇）
- 移除SQL注入风险的字符
- 只允许SELECT查询

### 4. 用户友好的反馈
- 显示生成的SQL查询（供学习参考）
- 提供详细的错误提示
- 显示查询结果统计和示例

## 界面优化

### 1. 更新的提示文字
```
支持中文自然语言查询，例如：
• 查找量子位发布的关于AI的文章
• 最近3天的文章，只要前10篇
• 包含'人工智能'关键词的文章
• 今天发布的文章按时间排序
```

### 2. 实时状态反馈
- 查询进行中显示"查询中..."
- 显示生成的SQL语句
- 展示查询结果数量和示例
- 无结果时提供改进建议

## 使用指南

### 基本使用
1. 在智能查询框中输入自然语言查询
2. 点击"智能查询"按钮
3. 查看查询结果和生成的SQL
4. 结果显示在右侧文章表格中

### 查询技巧
1. **明确指定公众号**：`量子位发布的文章`
2. **使用具体关键词**：`关于机器学习的文章`
3. **指定时间范围**：`最近3天的文章`
4. **限制结果数量**：`只要前10篇`
5. **组合多个条件**：`量子位最近一周关于AI的文章，前5篇`

### 故障排除
- **无查询结果**：检查关键词拼写、时间范围、公众号名称
- **查询过慢**：减少时间范围或添加更具体的条件
- **结果不准确**：使用更明确的关键词或公众号名称

## 技术优势

### 1. 本地化处理
- 无需外部API调用
- 响应速度快
- 不依赖网络连接
- 保护用户隐私

### 2. 扩展性强
- 易于添加新的查询模式
- 可以调整解析规则
- 支持复杂的组合查询

### 3. 用户体验好
- 自然语言输入，学习成本低
- 实时反馈，结果可见
- 错误提示详细，便于调试

## 与WeChat.py的对比

| 特性 | WeChat.py (完整版) | main.py (优化版) |
|-----|-------------------|-----------------|
| AI模型依赖 | 需要GPT等API | 无需外部API |
| 查询准确性 | 极高 | 中等偏上 |
| 响应速度 | 慢（需网络请求） | 快（本地处理） |
| 功能复杂度 | 支持复杂SQL | 支持基本查询 |
| 部署复杂度 | 需配置API密钥 | 开箱即用 |
| 成本 | 有API调用费用 | 免费 |

## 总结

通过参考WeChat.py的设计理念，我们成功实现了一个本地化的智能查询系统。虽然在复杂查询处理上不如完整的AI模型，但在常见的查询场景下完全能够满足用户需求，并且具有响应快、无依赖、易部署的优势。

这种渐进式的功能实现策略，确保了基础功能的稳定可用，同时为未来的AI集成留下了接口和扩展空间。 